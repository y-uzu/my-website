<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
  import { getDatabase, ref, push, onValue } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB7y2PzAQhynKBM3FaQ8oQ13Rh8Gau4Up0",
    authDomain: "kokorohourensou.firebaseapp.com",
    projectId: "kokorohourensou",
    storageBucket: "kokorohourensou.appspot.com",
    messagingSenderId: "153563519799",
    appId: "1:153563519799:web:c4f9a667f188d70994d8b2",
    measurementId: "G-VZ3EF0JW89"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const database = getDatabase(app);

  function getQueryParam(name) {
    const params = new URLSearchParams(location.search);
    return params.get(name);
  }

  function getToday() {
    const d = new Date();
    return d.toISOString().slice(0, 10);
  }

  function saveStatus(group, date, name, stamp, comment) {
    const statusRef = ref(database, `groups/${group}/statuses/${date}`);
    const newStatus = {
      name,
      stamp,
      comment,
      timestamp: Date.now()
    };
    push(statusRef, newStatus);
  }

  function listenStatus(group, date, callback) {
    const statusRef = ref(database, `groups/${group}/statuses/${date}`);
    onValue(statusRef, snapshot => {
      const data = snapshot.val();
      const arr = data ? Object.values(data) : [];
      callback(arr);
    });
  }

  function showTodayStatus(group, date) {
    listenStatus(group, date, arr => {
      if (arr.length === 0) {
        document.getElementById('todayStatus').innerHTML = 'まだ今日の気持ちは投稿されていません。';
        return;
      }
      let html = `<h2>今日のみんなの気持ち</h2>`;
      arr.forEach(item => {
        html += `<div><strong>${item.name}</strong>：${item.stamp} ${item.comment ? '（' + item.comment + '）' : ''}</div>`;
      });
      document.getElementById('todayStatus').innerHTML = html;
    });
  }

  function showCalendarStatus(group, date) {
    listenStatus(group, date, arr => {
      const calendarDays = document.getElementById('calendarDays');
      calendarDays.innerHTML = '';
      if (arr.length === 0) {
        calendarDays.innerHTML = `<div class="calendar-day">この日の投稿はありません。</div>`;
        return;
      }
      arr.forEach(item => {
        const div = document.createElement('div');
        div.className = 'calendar-day';
        div.innerHTML = `<strong>${item.name}</strong>：${item.stamp} ${item.comment ? '（' + item.comment + '）' : ''}`;
        calendarDays.appendChild(div);
      });
    });
  }

  document.getElementById('createGroupBtn').onclick = function () {
    const groupName = document.getElementById('newGroupName').value.trim();
    if (!groupName) {
      document.getElementById('groupUrlMsg').textContent = 'グループ名を入力してください。';
      return;
    }
    const url = location.origin + location.pathname + '?group=' + encodeURIComponent(groupName);
    document.getElementById('groupUrlMsg').innerHTML = 'このURLをメンバーに送ってください：<br><a href="' + url + '">' + url + '</a>';
  };

  document.getElementById('shareStatusBtn').onclick = function () {
    const name = document.getElementById('userName').value.trim();
    const stamp = document.getElementById('selectedStamp').value;
    const comment = document.getElementById('comment').value.trim();
    const group = getQueryParam('group');
    if (!name) {
      alert('名前を入力してください');
      return;
    }
    if (!stamp) {
      alert('今日の状態スタンプを選んでください');
      return;
    }
    const date = getToday();
    saveStatus(group, date, name, stamp, comment);

    // 入力欄リセット
    document.getElementById('userName').value = '';
    document.getElementById('selectedStamp').value = '';
    document.getElementById('comment').value = '';
    document.querySelectorAll('.stampBtn').forEach(b => b.style.border = '');
  };

  window.onload = function () {
    const group = getQueryParam('group');
    if (group) {
      document.getElementById('groupCreateSection').style.display = 'none';
      document.getElementById('statusSection').style.display = 'block';
      document.getElementById('calendarSection').style.display = 'block';
      const today = getToday();
      showTodayStatus(group, today);

      flatpickr("#calendarPicker", {
        dateFormat: "Y-m-d",
        defaultDate: today,
        onChange: function (selectedDates, dateStr) {
          showCalendarStatus(group, dateStr);
        }
      });
      showCalendarStatus(group, today);
    }
  };

  document.querySelectorAll('.stampBtn').forEach(btn => {
    btn.onclick = function () {
      document.getElementById('selectedStamp').value = btn.dataset.stamp;
      document.querySelectorAll('.stampBtn').forEach(b => b.style.border = '');
      btn.style.border = '2px solid #1976d2';
    };
  });
</script>
